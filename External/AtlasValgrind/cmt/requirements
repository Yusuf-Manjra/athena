package AtlasValgrind

author  Sebastien Binet <binet@cern.ch>
## for athena policies: this has to be the first use statement
use AtlasPolicy         AtlasPolicy-*

use LCG_Settings        v*
use ExternalPolicy 	ExternalPolicy-*        External
use valgrind		v*			LCG_Interfaces

# pick up version from LCG
#macro AtlasValgrind_native_version "3.9.0"
#macro AtlasValgrind_version "3.9" \
#      WIN32            "39"
macro AtlasValgrind_native_version "$(valgrind_config_version)"

macro AtlasValgrind_basesystem "$(LCG_basesystem)" \
      host-i686&host-slc5&target-gcc41 "i686-slc5-gcc41" \
      host-i686&host-slc5&target-gcc43 "i686-slc5-gcc43" \
      host-i686&host-slc5&target-gcc44 "i686-slc5-gcc44" \
      host-i686&host-slc5&target-gcc45 "i686-slc5-gcc45" \
      host-x86_64&host-slc5&target-gcc41 "x86_64-slc5-gcc41" \
      host-x86_64&host-slc5&target-gcc43 "x86_64-slc5-gcc43" \
      host-x86_64&host-slc5&target-gcc44 "x86_64-slc5-gcc44" \
      host-x86_64&host-slc5&target-gcc45 "x86_64-slc5-gcc45" \
      host-x86_64&host-slc6&target-clang "x86_64-slc6-gcc49"

macro AtlasValgrind_system "$(AtlasValgrind_basesystem)-opt" \
      target-opt           "$(AtlasValgrind_basesystem)-opt" \
      target-dbg           "$(AtlasValgrind_basesystem)-opt"

macro AtlasValgrind_home "$(LCG_external)/valgrind/$(AtlasValgrind_native_version)/$(AtlasValgrind_system)"
macro AtlasValgrind_inc "$(AtlasValgrind_home)/include"

macro AtlasValgrind_libdir "$(AtlasValgrind_home)/lib/valgrind"

include_path none
include_dirs $(AtlasValgrind_inc)

branches share

# declare (atlas) suppression  file(s)
apply_pattern declare_runtime files="*.supp"

###################
### kit-support ###
#macro AtlasValgrind_export_paths $(AtlasValgrind_home)
# export all 32/64 versions of valgrind for the kit.

macro AtlasValgrind_config "$(CMTCONFIG)" \
      host-x86_64&host-slc6&target-clang&target-opt "x86_64-slc6-gcc49-opt" \
      host-x86_64&host-slc6&target-clang&target-dbg "x86_64-slc6-gcc49-dbg" \

macro AtlasValgrind_export_paths "\
 $(LCG_external)/valgrind/$(AtlasValgrind_native_version)/$(AtlasValgrind_config) 
"

###################

path_remove LD_LIBRARY_PATH "/valgrind/" \
            WIN32           "\valgrind"
path_prepend LD_LIBRARY_PATH "$(AtlasValgrind_libdir)" \
            WIN32            ""

path_remove  PATH  "/valgrind/" \
             WIN32 "\valgrind"
path_prepend PATH  "$(AtlasValgrind_home)/bin" \
             WIN32 "$(AtlasValgrind_home)"

# FIXME: what should we link against ?
#macro AtlasValgrind_linkopts " -L$(Valgrind_libdir) -lvex -lgcc"\
#      WIN32 ""

macro_append AtlasValgrind_linkopts "" \
      build_Valgrind_tool      " -lcoregrind"

set VALGRIND_LIB "$(AtlasValgrind_libdir)"

# needed for root-6 now; smc=self-modifying-code
# (ba)sh accepts undefined variables, unlike tcsh, so overwrite, if set
set VALGRIND_OPTS " --smc-check=all "
