package AtlasGPerfTools

#
# This glue package was written to help with profiling Athena
# jobs. To use it, you have to add
#
#   use AtlasGPerfTools AtlasGPerfTools-* External
#   macro_append MyPkg_use_linkopts " $(AtlasGPerfTools_linkopts_profiler)"
#
# to your requirements file, and surround the code you want to
# profile with:
#
#   ProfilerStart( "myJob.profile" );
#   ...
#   ProfilerStop();
#
# Usually it's a good idea to put the first line into some
# initialization, and the second one into some finalization
# function.
#

author Attila Krasznahorkay <Attila.Krasznahorkay@cern.ch>

## for athena policies: this has to be the first use statement
use AtlasPolicy 	AtlasPolicy-*

## for external policies
use ExternalPolicy ExternalPolicy-* External
use PyCmt		   PyCmt-*		    Tools -no_auto_imports
use AtlasLibUnwind *                External

macro AtlasGPerfTools_linkopts_tcmalloc " -ltcmalloc"
macro AtlasGPerfTools_linkopts_tcmalloc_minimal " -ltcmalloc_minimal"
macro AtlasGPerfTools_linkopts_tcmalloc_profiler " -ltcmalloc_and_profiler"
macro AtlasGPerfTools_linkopts_profiler " -lprofiler"

# to easily locate the libraries
set ATLAS_GPERFTOOLS_DIR $(CMTINSTALLAREA)/$(CMTCONFIG)/lib

macro AtlasGPerfTools_linkopts "" \
  use_gpt_tcmalloc " $(AtlasGPerfTools_linkopts_tcmalloc)" \
  use_gpt_tcmalloc_minimal " $(AtlasGPerfTools_linkopts_tcmalloc_minimal) " \
  use_gpt_tcmalloc_profiler " $(AtlasGPerfTools_linkopts_tcmalloc_profiler) " \
  use_gpt_profiler " $(AtlasGPerfTools_linkopts_profiler) " \
  none "" 

private

apply_pattern make_pkgbuild \
 name=gperftools \
 file=pkgbuild_gperftools.py

branches src bin

end_private

private

apply_pattern declare_scripts files="\
 -s=$(AtlasGPerfTools_root)/bin \
atl-gpt-analyze \
atl-gpt-cpu-profile \
atl-gpt-mem-profile \
"
end_private

# define path for tcmalloc needed for preloading of tcmalloc during a athena job
set TCMALLOCDIR $(AtlasGPerfTools_cmtpath)/InstallArea/$(CMTCONFIG)/lib
include_dirs $(AtlasGPerfTools_cmtpath)/InstallArea/include