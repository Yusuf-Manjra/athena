<span class="twiki-macro CERTIFY"></span>

# Powheg on-the-fly in ATLAS

<span class="twiki-macro TOC"></span>
<span class="twiki-macro STARTINCLUDE"></span>

# Frequently Asked Questions

<span class="twiki-macro TWISTY twikiHelp" data-mode="div" data-showlink="Expand Frequently Asked Questions" data-hidelink="Frequently Asked Questions" data-showimgright="%ICONURLPATH{toggleopen-small}%" data-hideimgright="%ICONURLPATH{toggleclose-small}%"></span>

**How do I generate events with Powheg OTF?**

  - Use `Generate_tf` as explained
    [here](PowhegForATLAS#Generating_events_with_Powheg_OT)

**How do I stop my parton shower from running out of events?** If you're
seeing lines like this in your log file

\<sticky\> <span class="twiki-macro CODE" lang="changelog"></span>
17:11:52 PYTHIA Abort from Pythia::next: reached end of Les Houches
Events File... <span class="twiki-macro ENDCODE"></span> \</sticky\>

then you've run out of LHE events before enough events have passed your
generator filter and been written to your EVNT file. You can increase
the number of events generated by Powheg by adding a line like

\<sticky\> <span class="twiki-macro CODE" lang="python"></span>
PowhegConfig.nEvents \*= 1.2 <span class="twiki-macro ENDCODE"></span>
\</sticky\>

to your jobOptions. This particular example will ask PowhegBox to
generate an additional 20% more events on top of how many are already
requested (the default number if nothing is specified would be 10% more
than requested in the `Generate_tf` parameters). Adjust this value as
appropriate for your needs - typically you will want to use `1.0 /
filter_efficiency` with an extra buffer to account for the fact that the
actual filter efficiency will be different from run-to-run.

**How do I run with additional event weights?**

  - See [here](PowhegForATLAS#Running_with_multiple_scale_PDF) for
    PDF/scale weights and
    [here](PowhegForATLAS#Running_with_multiple_non_scale) for other
    weights.

**How do I request support for a new process?**

  - Make a JIRA request as explained
    [here](PowhegForATLAS#Requesting_new_processes)

**Where are the user-configurable options listed?**

  - If you run jobOptions that include the Powheg process that you're
    interested in, you'll see these at the top of the log file
    (`log.generate`). See
    [here](PowhegForATLAS#Changing_parameters_in_the_jobOp) for more
    details.

**How long will generation typically take?**

  - Typical times for interactive lxplus runs are shown
    [here](PowhegForATLAS#Approximate_generation_time)

**How can I speed up long-running processes?**

The first thing to do here is to check what's taking the time. Look for
lines like this in your log file

\<sticky\> <span class="twiki-macro CODE" lang="changelog"></span>
22:11:20 Py:PowhegControl INFO Running nominal Powheg took 0h 06m 06s
for 1100 events =\> 3.0024 Hz ... 03:37:45 Py:PowhegControl INFO Running
Powheg afterburners took 5h 26m 25s
<span class="twiki-macro ENDCODE"></span> \</sticky\>

This will tell you how much time is being spent on generating events and
how much time is taken by calculating additional weights (if
applicable). If most of the time is taken in event generation, then
re-use of integration grids is explained
[here](PowhegForATLAS#Re_using_integration_files)

**How can I generate integration grids for a long-running process?**

  - Check
    [here](https://twiki.cern.ch/twiki/bin/view/AtlasProtected/PowhegForATLAS#Generating_integration_grids)

**How can I tell whether the integration grids are being loaded?**

  - Check `log.generate` for the appropriate lines listed in the table
    [here](PowhegForATLAS#Re_using_integration_files)

**Which SVN release of the POWHEG-BOX process am I using?**

  - Setup the release as usual with `asetup $my_athena_version`
  - Find the version of `External/Powheg` by running `cmt show versions
    External/Powheg`
  - Look up the SVN release of the POWHEG-BOX process in the table
    linked from [here](PowhegForATLAS#External_Powheg)

**How do I enable generator-level multiple event weights?**

  - For renormalisation/factorisation scale changes or PDF reweighting,
    see [this section](PowhegForATLAS#Running_with_multiple_scale_PDF)
  - For other weights such as NNLOPS/DYNNLO, `hdamp` or other parameter
    changes, see [this
    section](PowhegForATLAS#Running_with_multiple_non_scale)

**Which processes have MiNLO enabled?**

  - See the list [here](PowhegForATLAS#Multi_scale_improved_NLO)

<span class="twiki-macro ENDTWISTY"></span>

-----

# Introduction

This page gives an introduction to the Monte Carlo (MC) generator
collection POWHEG-BOX. POWHEG (Positive Weight Hardest Emission
Generator) is a method to generate MC events that is accurate at the
next-to-leading order (NLO) in QCD which can be interfaced to various
different parton-shower Monte Carlo programs, such as
[Herwig](HerwigForAtlas), [Jimmy](JimmyForAtlas) and
[Pythia](PythiaForAtlas), in such a way that both the leading
logarithmic accuracy of the shower and the NLO accuracy are maintained
in the output. MC generators based on the POWHEG method are thus
alternatives to generators like [MC@NLO](MCatNLOForAtlas) generator.
POWHEG-BOX can be run within Athena by using the `PowhegControl`
package. The GenEvent HepMC output is put into Atlas.StoreGate and may
be used by other packages (e.g full simulation, Atlfast, Rivet...) in
the usual way.

Please bear in mind that some processes can take a very long time to
run. See PowhegForATLAS\#Generators\_PowhegControl for more details.

## Powheg on-the-fly within Athena

Powheg on-the-fly (OTF) is a convenient interface to a series of
different POWHEG-BOX processes which allows easy event generation using
the standard ATLAS generation scripts.

Two packages are needed to run Powheg within Athena: a steering package
(`Generators/PowhegControl`) and a wrapper package for calling the
external POWHEG-BOX process (`External/Powheg`). These are both present
in the 19.X series (currently being used for MC15 production) as well as
in the 17.2.X series (currently being used for MC12 production).

  - [PowhegControl master (21.6 release branch) on
    Gitlab](https://gitlab.cern.ch/atlas/athena/tree/21.6/Generators/PowhegControl)
  - [Powheg trunk in
    SVN](https://svnweb.cern.ch/trac/atlasoff/browser/External/Powheg/trunk)

Further details about these packages are available in the following
sections:
[Generators/PowhegControl](PowhegForATLAS#Generators_PowhegControl) and
[External/Powheg](PowhegForATLAS#External_Powheg).

## Recommended releases

Powheg OTF is available in most recent athena releases (a full list is
[here](http://atlas-project-mc-production.web.cern.ch/atlas-project-mc-production/Generators/AtlasProduction)).
The recommendation is always to use the most recent release (unless
specifically noted otherwise). Currently this means

\<div align="center"\>

| Release series | External/Powheg Tag | Generators/PowhegControl Tag | First release with these tags | Known issues |
| :------------: | :-----------------: | :--------------------------: | ----------------------------: | :----------- |
|      r19       |   Powheg-00-03-10   |    PowhegControl-00-03-00    |                     19.2.5.26 | None         |
|      r17       |   Powheg-00-02-07   |    PowhegControl-00-02-17    |                    17.2.14.14 | None         |

\</div\>

See [this section](PowhegForATLAS#External_Powheg) for the corresponding
installation for each tag.

-----

# Powheg OTF interface: more details

## External/Powheg

Currently, only some of the processes available in POWHEG-BOX have been
implemented in the on-the-fly Athena package. Processes are installed on
afs and migrated to cvmfs, so they should be available to anyone setting
up Athena in the standard way. It is often useful to know the specific
version of a Powheg OTF process that was used to generate a particular
dataset (for example, for correct citation in a paper). Currently a
mixture of POWHEG-BOX V1, POWHEG-BOX V2 and POWHEG-BOX-RES processes are
used - migration to V2 is dependent on the process authors updating
their code, so if you need V2 features (such as PDF reweighting) in a V1
process, a request might need to be made to the process authors.

\<center\>**POWHEG-BOX SVN revisions for the processes used in each
`External/Powheg` tag are listed <span class="twiki-macro RED"></span>
[HERE](https://docs.google.com/spreadsheets/d/16XvI5k2I2On4TkkIWJC9MXr0fMaRU2SvOkgBucRPzs0)
<span class="twiki-macro ENDCOLOR"></span> in a Google doc.**\</center\>

Use of older versions is **NOT** recommended, but they are included in
the spreadsheet above so that samples generated with these tags can be
documented.

Please note that release 19 versions are compiled against
<span class="twiki-macro RED"></span> **LHAPDF6**
<span class="twiki-macro ENDCOLOR"></span>, while release 17 versions
are compiled against <span class="twiki-macro RED"></span> **LHAPDF5**
<span class="twiki-macro ENDCOLOR"></span>. Also be aware of this list
of known bugs in particular POWHEG-BOX releases:
<http://powhegbox.mib.infn.it/release_bugs_V2.txt>

## Generators/PowhegControl

The currently installed processes are listed
[here](PowhegForATLAS#List_of_supported_processes_and), together with
the first available Athena release with that process included. For
consistency, the names of some processes in Athena are **different**
from the names of the underlying POWHEG-BOX module; please see the table
for detail.

The best release to use is whatever is used in the current round of MC
production: see [this section](PowhegForATLAS#Recommended_releases) for
more details

## List of supported processes

\<div align="center"\>

| PowhegControl name | POWHEG-BOX name         | Process description           | Available since                                                          | Citation           |
| :----------------- | :---------------------- | :---------------------------- | :----------------------------------------------------------------------- | :----------------- |
| `bb`               | hvq                     | bbbar                         | `PowhegControl-00-00-08`                                                 | `arXiv:0707.3088`  |
| `bbH`              | \-                      | bbbar+Higgs                   | `PowhegControl-00-03-10`                                                 | `arXiv:1509.05843` |
| `bblvlv`           | b\_bbar\_4l             | ttbar / Wt interference       | `PowhegControl-00-03-00`                                                 | `arXiv:1607.04538` |
| `chi0chi0`         | weakinos/neuIneuJ       | neutralino pair               | `PowhegControl-00-03-00`                                                 | `arXiv:1605.06509` |
| `chi0chi1`         | weakinos/neuIchaJ       | neutralino + chargino         | `PowhegControl-00-03-00`                                                 | `arXiv:1605.06509` |
| `chi1chi1`         | weakinos/chaIchaJ       | chargino pair                 | `PowhegControl-00-03-00`                                                 | `arXiv:1605.06509` |
| `DMGG`             | \-                      | dark matter                   | `PowhegControl-00-02-08`                                                 | `arXiv:1310.4491`  |
| `DMS_tloop`        | \-                      | dark matter                   | `PowhegControl-00-02-08`                                                 | `arXiv:1503.00691` |
| `DMV`              | \-                      | dark matter                   | `PowhegControl-00-02-08`                                                 | `arXiv:1310.4491`  |
| `ggF_H`            | ggH\_quark-mass-effects | gg-\>H                        | `PowhegControl-00-02-00`                                                 | `arXiv:1111.2854`  |
| `ggF_HH`           | ggHH                    | gg-\>HH                       | %GREEN%NEW<span class="twiki-macro END"></span> `PowhegControl-00-03-12` | `arXiv:1703.09252` |
| `ggF_HZ`           | ggHZ                    | gg-\>H+Z                      | `PowhegControl-00-02-00`                                                 | no citation        |
| `Hj`               | HJ                      | Higgs+1 jet                   | `PowhegControl-00-02-05`                                                 | `arXiv:1202.5475`  |
| `Hjj`              | HJJ                     | Higgs+2 jets                  | `PowhegControl-00-02-05`                                                 | `arXiv:1202.5475`  |
| `HWj`              | HWJ                     | Higgs+W+1 jet                 | `PowhegControl-00-02-00`                                                 | `arXiv:1306.2542`  |
| `HWj_EW`           | HWJ\_EW                 | Higgs+W+1 jet with EW effects | `PowhegControl-00-03-10`                                                 | `arXiv:1706.03522` |
| `HZj`              | HZJ                     | Higgs+Z+1 jet with EW effects | `PowhegControl-00-02-00`                                                 | `arXiv:1306.2542`  |
| `HZj_EW`           | HZJ\_EW                 | Higgs+Z+1 jet                 | `PowhegControl-00-03-10`                                                 | `arXiv:1706.03522` |
| `jj`               | dijet                   | dijet                         | `PowhegControl-00-00-08`                                                 | `arXiv:1012.3380`  |
| `jjj`              | trijet                  | trijet                        | `PowhegControl-00-00-12`                                                 | `arXiv:1402.4001`  |
| `ssWWjj`           | Wp\_Wp\_J\_J            | same-sign WW+2 jets           | `PowhegControl-00-02-14`                                                 | `arXiv:1102.4846`  |
| `t_sch`            | ST\_sch                 | single t (s-channel)          | `PowhegControl-00-02-09`                                                 | `arXiv:0907.4076`  |
| `t_tch_4FS`        | ST\_tch\_4f             | single t (s-channel) 4FS      | `PowhegControl-00-03-00`                                                 | `arXiv:1207.5391`  |
| `tt`               | hvq                     | ttbar                         | `PowhegControl-00-00-10`                                                 | `arXiv:0707.3088`  |
| `tt_NLOdecays`     | ttb\_NLO\_dec           | ttbar with NLO decays         | `PowhegControl-00-03-00`                                                 | `arXiv:1412.1828`  |
| `ttH`              | \-                      | ttbar+Higgs                   | `PowhegControl-00-02-09`                                                 | `arXiv:1501.04498` |
| `ttj`              | ttJ                     | ttbar+1 jet                   | `PowhegControl-00-02-14`                                                 | `arXiv:1110.5251`  |
| `VBF_H`            | \-                      | VBF Higgs                     | `PowhegControl-00-02-00`                                                 | `arXiv:0911.5299`  |
| `VBF_ssWW`         | Wp\_Wp\_J\_J            | VBF same-sign WW              | `PowhegControl-00-02-14`                                                 | `arXiv:1108.0864`  |
| `VBF_W`            | VBF\_W-Z                | VBF W                         | `PowhegControl-00-02-17`                                                 | `arXiv:1302.2884`  |
| `VBF_Z`            | VBF\_W-Z                | VBF Z                         | `PowhegControl-00-02-17`                                                 | `arXiv:1302.2884`  |
| `W`                | \-                      | W                             | `PowhegControl-00-00-09`                                                 | `arXiv:0805.4802`  |
| `Wbb`              | Wbb\_dec                | W (-\> l nu) + bbbar          | `PowhegControl-00-03-00`                                                 | `arXiv:1502.01213` |
| `Wbbj`             | Wbbj                    | W (-\> l nu) + bbbar + jet    | `PowhegControl-00-03-00`                                                 | `arXiv:1502.01213` |
| `W_EW`             | W\_ew-BMNNP             | W with EW effects             | `PowhegControl-00-02-18`                                                 | `arXiv:1202.0465`  |
| `Wj`               | \-                      | W+1 jet                       | `PowhegControl-00-00-09`                                                 | `arXiv:1009.5594`  |
| `Wjj`              | \-                      | W+2 jets                      | `PowhegControl-00-02-17`                                                 | `arXiv:1303.5447`  |
| `Wt_DR`            | ST\_wtch\_DR            | W+t (diagram removal)         | `PowhegControl-00-02-01`                                                 | `arXiv:1009.2450`  |
| `Wt_DS`            | ST\_wtch\_DS            | W+t (diagram subtraction)     | `PowhegControl-00-02-09`                                                 | `arXiv:1009.2450`  |
| `WW`               | \-                      | W+W-                          | `PowhegControl-00-00-08`                                                 | `arXiv:1311.1365`  |
| `Wy`               | Wgamma                  | W+gamma                       | `PowhegControl-00-03-10`                                                 | `arXiv:1410.3802`  |
| `WZ`               | \-                      | WZ                            | `PowhegControl-00-00-08`                                                 | `arXiv:1311.1365`  |
| `Z`                | \-                      | Z                             | `PowhegControl-00-00-09`                                                 | `arXiv:0805.4802`  |
| `Z_EW`             | Z\_ew-BMNNPV            | Z with EW effects             | `PowhegControl-00-02-18`                                                 | `arXiv:1302.4606`  |
| `Zj`               | \-                      | Z+1 jet                       | `PowhegControl-00-00-09`                                                 | `arXiv:1009.5594`  |
| `Zjj`              | \-                      | Z+2 jets                      | `PowhegControl-00-02-17`                                                 | `arXiv:1303.5447`  |
| `ZZ`               | \-                      | ZZ                            | `PowhegControl-00-00-08`                                                 | `arXiv:1311.1365`  |

\</div\>

-----

# Generating events with Powheg OTF

If you are using a reasonably new release, both
`Generators/PowhegControl` and `External/Powheg` will already be
included. If you want to use a different version of either of these
packages than the one in your release, or if you want to run in a
release for which these packages are not already present, you will need
to check out the packages as detailed
[here](PowhegForATLAS#Using_a_specific_tag_or_the_trun)

## Validation and approximate generation time

Using the default settings, the **approximate** time taken to generate
5000 events (including the integration, event generation and
hadronisation steps) is given below. As described in
[PowhegForATLAS\#Re\_using\_integration\_files](PowhegForATLAS#Re_using_integration_files),
the integration step can be skipped by re-using the integration grids.
If the integration step is takes longer than **3 hours** to run this
should be considered. If this step takes longer than **6 hours** it
might become mandatory in future to re-use the integration files in
production. Anything that takes longer than **24 hours** may well be
impossible to run in production without re-use of the integration grids.

Before generating events, POWHEG-BOX performs an integration over a
multi-dimensional parameter space. This can be quite slow and so the
integration parameters must be chosen in order to get a balance between
speed and precision. The values used in `PowhegControl` have been chosen
in line with the following guidelines recommended by the POWHEG-BOX
authors.

\<div align="center"\>

| Test description          | Requirement                  |
| :------------------------ | :--------------------------- |
| Cross section uncertainty | \< 1% of total cross section |
| Negative weight events    | \< 1% of events              |
| Upper bound failures      | \< 1% of events              |

\</div\>

Wherever possible, we choose default settings that will pass all of
these tests. The tests are automatically performed by PowhegControl, so
in the `log.generate` file produced when running the jobOptions you will
see output like

\<sticky\> <span class="twiki-macro CODE" lang="bash"></span> 19:25:39
Py:PowhegControl INFO Integration test :: cross-section uncertainty :
0.30% 19:25:39 Py:PowhegControl INFO Integration test :: negative weight
fraction : 0.52% 19:25:39 Py:PowhegControl INFO Integration test ::
upper bound violations : 0.82% 19:25:39 Py:PowhegControl INFO -\> in
inclusive cross-section : 0.82% 19:25:39 Py:PowhegControl INFO -\> in
generation of radiation : 0.00%
<span class="twiki-macro ENDCODE"></span> \</sticky\>

In the table below, you can see the results of each of these tests for
each supported process. In each case, if the test result is less than 1%
then it's shown in \<span style="background-color:\#009933"\>\<font
color="\#ffffff"\>green\</font\>\</span\>, if it's between 1% and 10%
then it's shown in \<span style="background-color:\#ffa500"\>\<font
color="\#ffffff"\>orange\</font\>\</span\> while those greater than 10%
are shown in \<span style="background-color:\#cc0000"\>\<font
color="\#ffffff"\>red\</font\>\</span\>. If you generate events with
processes where any of the tests have failed, you should check carefully
whether the events that pass your analysis selection give physical
(non-zero) results in a variety of sensible observables.

\<div align="center"\>
<span class="twiki-macro TABLE" data-columnwidths="15%,5%,5%,5%,10%,10%,10%"></span>

| PowhegControl name | nCores | Approximate integration time (hrs) | Estimated generation time for 5000 events (hrs) | Cross-section uncertainty                        | Negative weight fraction                          | Upper bound violations                            | Physics validation |
| :----------------- | :----- | :--------------------------------- | :---------------------------------------------- | :----------------------------------------------- | :------------------------------------------------ | :------------------------------------------------ | :----------------- |
| `bb`               | 1      | 1                                  | 0.05                                            | <span class="twiki-macro PASSTEST"></span>       | <span class="twiki-macro PASSTEST"></span>        | <span class="twiki-macro PASSTEST"></span>        | NO                 |
| `bbH`              | 10     | 34                                 | 4                                               | %FAIL%\~45%<span class="twiki-macro END"></span> | %FAIL%\~55%<span class="twiki-macro END"></span>  | %FAIL%\~55%<span class="twiki-macro END"></span>  | NO                 |
| `bblvlv`           | 10     | 10.5                               | 1                                               | <span class="twiki-macro PASSTEST"></span>       | %WARN%\~2.5%<span class="twiki-macro END"></span> | <span class="twiki-macro PASSTEST"></span>        | NO                 |
| `chi0chi0`         | 1      | 10                                 | 1                                               | <span class="twiki-macro PASSTEST"></span>       | %FAIL%\~14%<span class="twiki-macro END"></span>  | <span class="twiki-macro PASSTEST"></span>        | NO                 |
| `chi0chi1`         | 1      | 0.05                               | 0.01                                            | <span class="twiki-macro PASSTEST"></span>       | <span class="twiki-macro PASSTEST"></span>        | <span class="twiki-macro PASSTEST"></span>        | NO                 |
| `chi1chi1`         | 1      | 3                                  | 0.05                                            | <span class="twiki-macro PASSTEST"></span>       | %FAIL%\~12%<span class="twiki-macro END"></span>  | <span class="twiki-macro PASSTEST"></span>        | NO                 |
| `DMGG`             | 1      | 0.5                                | 0.5                                             | <span class="twiki-macro PASSTEST"></span>       | <span class="twiki-macro PASSTEST"></span>        | <span class="twiki-macro PASSTEST"></span>        | NO                 |
| `DMS_tloop`        | 1      | 0.1                                | 0.01                                            | <span class="twiki-macro PASSTEST"></span>       | <span class="twiki-macro PASSTEST"></span>        | <span class="twiki-macro PASSTEST"></span>        | NO                 |
| `DMV`              | 1      | 2.5                                | 0.05                                            | <span class="twiki-macro PASSTEST"></span>       | <span class="twiki-macro PASSTEST"></span>        | <span class="twiki-macro PASSTEST"></span>        | NO                 |
| `ggF_H`            | 1      | 0.1                                | 0.01                                            | <span class="twiki-macro PASSTEST"></span>       | <span class="twiki-macro PASSTEST"></span>        | <span class="twiki-macro PASSTEST"></span>        | NO                 |
| `ggF_HH`           | 10     | 7                                  | 1.5                                             | <span class="twiki-macro PASSTEST"></span>       | <span class="twiki-macro PASSTEST"></span>        | <span class="twiki-macro PASSTEST"></span>        | NO                 |
| `ggF_HZ`           | 1      | 4.5                                | 0.5                                             | <span class="twiki-macro PASSTEST"></span>       | <span class="twiki-macro PASSTEST"></span>        | <span class="twiki-macro PASSTEST"></span>        | NO                 |
| `Hj`               | 1      | 16                                 | 1                                               | <span class="twiki-macro PASSTEST"></span>       | <span class="twiki-macro PASSTEST"></span>        | <span class="twiki-macro PASSTEST"></span>        | NO                 |
| `Hjj`              | 10     | 20                                 | 4                                               | <span class="twiki-macro PASSTEST"></span>       | %FAIL%\~11%<span class="twiki-macro END"></span>  | <span class="twiki-macro PASSTEST"></span>        | NO                 |
| `HWj`              | 1      | 13                                 | 1                                               | <span class="twiki-macro PASSTEST"></span>       | <span class="twiki-macro PASSTEST"></span>        | <span class="twiki-macro PASSTEST"></span>        | NO                 |
| `HWj_EW`           | 10     | 12                                 | 0.5                                             | <span class="twiki-macro PASSTEST"></span>       | <span class="twiki-macro PASSTEST"></span>        | %WARN%\~3%<span class="twiki-macro END"></span>   | NO                 |
| `HZj`              | 10     | 8.5                                | 1                                               | <span class="twiki-macro PASSTEST"></span>       | <span class="twiki-macro PASSTEST"></span>        | %WARN%\~1.5%<span class="twiki-macro END"></span> | NO                 |
| `HZj_EW`           | 10     | 29                                 | 0.5                                             | <span class="twiki-macro PASSTEST"></span>       | %WARN%\~1.5%<span class="twiki-macro END"></span> | %WARN%\~2.5%<span class="twiki-macro END"></span> | NO                 |
| `jj`               | 1      | 8.5                                | 1                                               | <span class="twiki-macro PASSTEST"></span>       | <span class="twiki-macro PASSTEST"></span>        | <span class="twiki-macro PASSTEST"></span>        | NO                 |
| `jjj`              | 10     | 26                                 | 1.5                                             | <span class="twiki-macro PASSTEST"></span>       | %FAIL%\~14%<span class="twiki-macro END"></span>  | <span class="twiki-macro PASSTEST"></span>        | NO                 |
| `ssWWjj`           | 10     | 18.5                               | 8                                               | %FAIL%\~40%<span class="twiki-macro END"></span> | <span class="twiki-macro PASSTEST"></span>        | %FAIL%\~65%<span class="twiki-macro END"></span>  | NO                 |
| `t_sch`            | 1      | 0.5                                | 0.01                                            | <span class="twiki-macro PASSTEST"></span>       | <span class="twiki-macro PASSTEST"></span>        | <span class="twiki-macro PASSTEST"></span>        | NO                 |
| `t_tch_4FS`        | 10     | 4.5                                | 1                                               | <span class="twiki-macro PASSTEST"></span>       | <span class="twiki-macro PASSTEST"></span>        | <span class="twiki-macro PASSTEST"></span>        | NO                 |
| `tt`               | 1      | 0.05                               | 0.01                                            | <span class="twiki-macro PASSTEST"></span>       | <span class="twiki-macro PASSTEST"></span>        | <span class="twiki-macro PASSTEST"></span>        | NO                 |
| `tt_NLOdecays`     | 1      | 2                                  | 0.1                                             | <span class="twiki-macro PASSTEST"></span>       | <span class="twiki-macro PASSTEST"></span>        | <span class="twiki-macro PASSTEST"></span>        | NO                 |
| `ttH`              | 1      | 1                                  | 0.1                                             | <span class="twiki-macro PASSTEST"></span>       | <span class="twiki-macro PASSTEST"></span>        | <span class="twiki-macro PASSTEST"></span>        | NO                 |
| `ttj`              | 1      | 20                                 | 4.5                                             | <span class="twiki-macro PASSTEST"></span>       | %FAIL%\~36%<span class="twiki-macro END"></span>  | %WARN%\~2%<span class="twiki-macro END"></span>   | NO                 |
| `VBF_H`            | 1      | 4                                  | 0.1                                             | <span class="twiki-macro PASSTEST"></span>       | <span class="twiki-macro PASSTEST"></span>        | <span class="twiki-macro PASSTEST"></span>        | NO                 |
| `VBF_ssWW`         | 10     | 16.5                               | 0.1                                             | <span class="twiki-macro PASSTEST"></span>       | %WARN%\~4%<span class="twiki-macro END"></span>   | <span class="twiki-macro PASSTEST"></span>        | NO                 |
| `VBF_W`            | 10     | 5.5                                | 0.1                                             | <span class="twiki-macro PASSTEST"></span>       | <span class="twiki-macro PASSTEST"></span>        | <span class="twiki-macro PASSTEST"></span>        | NO                 |
| `VBF_Z`            | 10     | 14                                 | 0.5                                             | <span class="twiki-macro PASSTEST"></span>       | %FAIL%\~9<span class="twiki-macro END"></span>    | <span class="twiki-macro PASSTEST"></span>        | NO                 |
| `W`                | 1      | 0.05                               | 0.01                                            | <span class="twiki-macro PASSTEST"></span>       | <span class="twiki-macro PASSTEST"></span>        | <span class="twiki-macro PASSTEST"></span>        | NO                 |
| `W_EW`             | 1      | 0.5                                | 0.01                                            | <span class="twiki-macro PASSTEST"></span>       | <span class="twiki-macro PASSTEST"></span>        | <span class="twiki-macro PASSTEST"></span>        | NO                 |
| `Wbb`              | 1      | 13                                 | 0.2                                             | <span class="twiki-macro PASSTEST"></span>       | <span class="twiki-macro PASSTEST"></span>        | <span class="twiki-macro PASSTEST"></span>        | NO                 |
| `Wbbj`             | 10     | 31                                 | 0.5                                             | <span class="twiki-macro PASSTEST"></span>       | %FAIL%\~4%<span class="twiki-macro END"></span>   | <span class="twiki-macro PASSTEST"></span>        | NO                 |
| `Wj`               | 10     | 10                                 | 0.1                                             | <span class="twiki-macro PASSTEST"></span>       | <span class="twiki-macro PASSTEST"></span>        | <span class="twiki-macro PASSTEST"></span>        | NO                 |
| `Wjj`              | 10     | 30                                 | 0.5                                             | <span class="twiki-macro PASSTEST"></span>       | %FAIL%\~20%<span class="twiki-macro END"></span>  | <span class="twiki-macro PASSTEST"></span>        | NO                 |
| `Wt_DR`            | 1      | 0.2                                | 0.01                                            | <span class="twiki-macro PASSTEST"></span>       | <span class="twiki-macro PASSTEST"></span>        | <span class="twiki-macro PASSTEST"></span>        | NO                 |
| `Wt_DS`            | 1      | 12                                 | 0.1                                             | <span class="twiki-macro PASSTEST"></span>       | <span class="twiki-macro PASSTEST"></span>        | <span class="twiki-macro PASSTEST"></span>        | NO                 |
| `WW`               | 1      | 0.1                                | 0.01                                            | <span class="twiki-macro PASSTEST"></span>       | <span class="twiki-macro PASSTEST"></span>        | <span class="twiki-macro PASSTEST"></span>        | NO                 |
| `Wy`               | 10     | 12                                 | 0.1                                             | <span class="twiki-macro PASSTEST"></span>       | %FAIL%\~8%<span class="twiki-macro END"></span>   | <span class="twiki-macro PASSTEST"></span>        | NO                 |
| `WZ`               | 1      | 2                                  | 0.05                                            | <span class="twiki-macro PASSTEST"></span>       | <span class="twiki-macro PASSTEST"></span>        | <span class="twiki-macro PASSTEST"></span>        | NO                 |
| `Z`                | 1      | 0.1                                | 0.01                                            | <span class="twiki-macro PASSTEST"></span>       | <span class="twiki-macro PASSTEST"></span>        | <span class="twiki-macro PASSTEST"></span>        | NO                 |
| `Z_EW`             | 1      | 2                                  | 0.2                                             | <span class="twiki-macro PASSTEST"></span>       | <span class="twiki-macro PASSTEST"></span>        | <span class="twiki-macro PASSTEST"></span>        | NO                 |
| `Zj`               | 10     | 8                                  | 0.2                                             | <span class="twiki-macro PASSTEST"></span>       | <span class="twiki-macro PASSTEST"></span>        | <span class="twiki-macro PASSTEST"></span>        | NO                 |
| `Zjj`              | 10     | 30                                 | 0.5                                             | <span class="twiki-macro PASSTEST"></span>       | %FAIL%\~35%<span class="twiki-macro END"></span>  | <span class="twiki-macro PASSTEST"></span>        | NO                 |
| `ZZ`               | 1      | 0.2                                | 0.01                                            | <span class="twiki-macro PASSTEST"></span>       | <span class="twiki-macro PASSTEST"></span>        | <span class="twiki-macro PASSTEST"></span>        | NO                 |

\</div\>

## Athena jobOptions using Powheg OTF

The POWHEG-BOX executables need to receive a runcard which specifies
various parameters and options. Default parameters are already set for
all the variables associated with each process, and these are
automatically set by including the relevant
`PowhegControl_MyProcess_Common.py` file. Each process can all be
accessed by changing the `MyProcess` in the jobOption include to the
name of the desired process. Example job options are available in
`Generators/PowhegControl/examples`. Here is an example for the
production of WZ events through the Powheg OTF interface.

\<sticky\> <span class="twiki-macro CODE" lang="python"></span>
include('PowhegControl/PowhegControl\_WZ\_Common.py')
PowhegConfig.generate()

include('MC15JobOptions/Pythia8\_A14\_NNPDF23LO\_EvtGen\_Common.py')
include('MC15JobOptions/Pythia8\_Powheg.py')

evgenConfig.description = 'POWHEG+Pythia8 bb production with A14
NNPDF2.3 tune' evgenConfig.keywords = \[ 'SM', 'diboson', 'W', 'Z' \]
evgenConfig.contact = \[ '<daniel.hayden@cern.ch>' \]
evgenConfig.minevents = 10 <span class="twiki-macro ENDCODE"></span>
\</sticky\>

## Changing parameters in the jobOptions using PowhegConfig

POWHEG-BOX processes have many parameters which can be changed from the
job options. In order to standardise the interface across processes, the
syntax for these commands has been changed slightly from what can be
found in the relevant POWHEG-BOX manual. A list of user-configurable
command is printed at the top of the `log.generate` file produced when
running Powheg OTF jobOptions.

For example, to require W+ Z -\> mu+ nu e+ e- in the WZ production
process described, you would add

\<sticky\> <span class="twiki-macro CODE" lang="python"></span>
PowhegConfig.decay\_mode = 'WpZmuvee'
<span class="twiki-macro ENDCODE"></span> \</sticky\>

giving an overall set of jobOptions like this:

\<sticky\> <span class="twiki-macro CODE" lang="python"></span>
include('PowhegControl/PowhegControl\_WZ\_Common.py')
PowhegConfig.decay\_mode = 'WpZmuvee' PowhegConfig.generate()

include('MC15JobOptions/Pythia8\_A14\_NNPDF23LO\_EvtGen\_Common.py')
include('MC15JobOptions/Pythia8\_Powheg.py')

evgenConfig.description = 'POWHEG+Pythia8 bb production with A14
NNPDF2.3 tune' evgenConfig.keywords = \[ 'SM', 'diboson', 'W', 'Z' \]
evgenConfig.contact = \[ '<daniel.hayden@cern.ch>' \]
evgenConfig.minevents = 10 <span class="twiki-macro ENDCODE"></span>
\</sticky\>

As the runcard for POWHEG-BOX is generated when the job options are run,
commands like this **MUST** be placed before the call to
`PowhegConfig.generate()`, or they will be ignored in favour of the
default settings.

## Running with Generate\_tf.py

These jobOptions should be run using `Generate_tf.py` in the usual way.
A sample Generate\_tf command might look like this:

\<sticky\> <span class="twiki-macro CODE" lang="bash"></span>
Generate\_tf.py --ecmEnergy 13000 --runNumber 147505 --firstEvent 1
--jobConfig MC15.147505.PowhegDijet\_Pythia8\_AU2\_CT10\_muR1muF1.py
--randomSeed 1 --outputEVNTFile Powheg.EVNT.root
<span class="twiki-macro ENDCODE"></span> \</sticky\>

for release 17, `Generate_trf.py` is used instead of `Generate_tf.py`
with slightly different syntax. The equivalent command to the above
would look like this:

\<sticky\> <span class="twiki-macro CODE" lang="bash"></span>
Generate\_trf.py ecmEnergy=8000 runNumber=147505 firstEvent=1
jobConfig=MC12.147505.PowhegDijet\_Pythia8\_AU2\_CT10\_muR1muF1.py
randomSeed=1 evgenJobOpts=MC12JobOpts-00-08-63\_v9.tar.gz
outputEVNTFile=Powheg.EVNT.root
<span class="twiki-macro ENDCODE"></span> \</sticky\>

-----

# Requesting new processes

If you would like a new process installed that is not on the list at
PowhegForATLAS\#List\_of\_supported\_processes\_and please let us know
by creating a new JIRA issue here:
<https://its.cern.ch/jira/browse/AGENE-968>. If there are problems with
the install/special instructions then the user is asked to debug and
provide instructions for the proper installation. The standard list of
steps needed are these

\<div align="center"\>

| Step number | Person responsible | Description                                                                                                                         | Approximate time |
| :---------- | :----------------- | :---------------------------------------------------------------------------------------------------------------------------------- | :--------------- |
| 1           | You                | Identify a release of POWHEG in which this process exists and compiles correctly                                                    | 1 day            |
| 2           | You                | Ask the Powheg on-the-fly authors to add this process                                                                               | \<1 day          |
| 3           | Us                 | Download, compile and debug the code at CERN                                                                                        | 1 days           |
| 4           | Us                 | Write a new interface class to ensure that Powheg OTF knows about the process                                                       | 1 day            |
| 5           | Us                 | Optimise the integration parameters for this process (if you know some which have been used previously, that would be a good start) | \>1 week         |
| 6           | Us                 | Generate a small test sample of events                                                                                              | \~1 week         |
| 7           | You/Us             | Test your generation setup works as expected                                                                                        | \~1 week         |
| 8           | You                | Perform whatever validation is requested by the MC generators group                                                                 | \>1 week         |
| 9           | You                | Make a JIRA request for whatever number of events you need                                                                          | \>1 week         |

\</div\>

Processes are only added by request, so please get in touch if you're
interested. One of the most time consuming steps in validating a new
process is finding optimal integration parameters (see
PowhegForATLAS\#POWHEG\_BOX\_integration\_parameter for more details).
If you are interested in helping us find optimal integration parameters,
please let us know\!

-----

# Advanced event generation

There are several options in POWHEG-BOX generation which can have
complicated effects - sometimes even rendering the output events
theoretically invalid. The defaults set in the `PowhegControl` package
should be correct for the majority of users, but it is possible for
advanced users to change them.

## POWHEG-BOX integration parameters

As discussed earlier, POWHEG-BOX performs an integration over a
multi-dimensional parameter space before generating events. The
parameters used for this integration must be tuned to get the best
generation speed while remaining adequately precise. The values used in
`PowhegControl` have been chosen in line with the following guidelines
recommended by the POWHEG-BOX authors.

\<div align="center"\>

| Test description                    | Requirement                  | How to reduce if this is too high                   |
| :---------------------------------- | :--------------------------- | :-------------------------------------------------- |
| Cross section uncertainty           | \< 1% of total cross section | increase `ncall1`, `itmx1`, `ncall2` and/or `itmx2` |
| Negative weight events              | \< 1% of events              | increase `foldx`, `foldy` and/or `foldphi`          |
| Upper bound failures: cross-section | \< 1% of events              | increase `ncall2`                                   |
| Upper bound failures: radiation     | \< 1% of events              | increase `nubound`, `xupbound`, `icsimax`, `iymax`  |

\</div\>

The output of these tests is reported in the `log.generate` file
produced when running the jobOptions. You will see output like

\<sticky\> <span class="twiki-macro CODE" lang="bash"></span> 00:52:07
Py:PowhegControl INFO Integration test :: cross-section uncertainty :
0.26% 00:52:07 Py:PowhegControl INFO Integration test :: negative weight
fraction : 0.77% 00:52:07 Py:PowhegControl INFO Integration test ::
upper bound violations : 0.90% <span class="twiki-macro ENDCODE"></span>
\</sticky\>

If any of the integration tests have failed, the INFO messages will be
WARNING messages, and you should increase the appropriate integration
parameters. In particular, changes to any of the following parameters
will invalidate the checks made in `PowhegControl` validation:
`bornktmin`, `bornsuppfact`, `foldx`, `foldy`, `foldphi`, `itmx1`,
`itmx2`, `ncall1`, `ncall2`, `nubound`, `xupbound`. In addition, changes
to the phase space under consideration (for example changing pT cuts or
masses of particles) can also invalidate these checks.

If you make any changes from the defaults for a particular process,
**YOU** are responsible for ensuring that the output passes these tests.

A more detailed automated testing suite for trying out and testing
different parameters is here:
<https://svnweb.cern.ch/cern/wsvn/atlas-jrobinso/PowhegAutomator/trunk/>;
please get in touch with Stefan Richter (<stefan.richter@cern.ch>) to
find out how to use this if you want to test several parameter sets.

An example where this has been done and documented is here:
<https://twiki.cern.ch/twiki/bin/view/AtlasProtected/DMProductionRun2#MC15_pilot_request>

## Generating integration grids

The easiest way to generate and test grids for long-running jobs is to
run on a batch system. A convenience script
(PowhegIntegrationGridGenerator) for doing this is available
[here](https://svnweb.cern.ch/cern/wsvn/atlas-jrobinso/PowhegIntegrationGridGenerator).
Please use the latest tag (currently
PowhegIntegrationGridGenerator-00-01-05). Instructions are contained in
the package.

## Event weights: Born-level suppression and negatives weights

Despite the name, POWHEG does generate negative weight events. The
default in ATLAS before `PowhegControl-00-02-09` was to reject these,
but now they are accepted by default in all processes. Allowing negative
weights can, in some cases, allow unphysical negative numbers of events
in poorly understood areas of phase space. Additionally, if the
`bornsuppfact` parameter is used to enable Born-level suppression,
`Powheg` will generate weighted events for which the average weight is
equal to the cross-section of the process in question. This can lead to
**very** large event weights in the case of events which have a
particularly low transverse momenta at the Born level, and then pick up
hard jets from the parton shower.

\<div align="center"\>

| Born-level suppression by default     | Negative weights by default | No weighting by default |
| :------------------------------------ | :-------------------------- | :---------------------- |
| `jjj`, `ssWWjj`, `ttj`, `Wbbj`, `Wbb` | All processes               | None                    |

\</div\>

If either Born-level suppression or negative weights are used (which is
the case for all processes by default) then the cross-section reported
by POWHEG-BOX will be incorrect. Please use the one printed by
PowhegControl in the log file instead. See the caveats here:
NegativeWeightPowheg

## Multi-scale improved NLO

Multi-scale improved NLO ([MiNLO](http://arxiv.org/abs/1206.3572)) is a
method for achieving NLO-accurate predictions for processes with
associated jets. It is enabled by default for all supported processes.
The list of processes for which MiNLO is enabled is: `Hj`, `Hjj`, `HWj`,
`HZj`, `jjj`, `Wbbj`, `Wj`, `Wjj`, `Zj`, `Zjj`

## Saving LHE files

By default, only the output EVNT files will be saved at the end of a
production run, but if the `--outputTXTFile` option of `Generate_tf.py`
is used then the LHE files will also be saved into whatever container
name is specified by this option.

## Using a specific tag (or the trunk) of PowhegControl

To use a specific tag of PowhegControl, you will need to check out the
code from SVN and compile it. The following example (in a **clean**
directory) will check

\<sticky\> <span class="twiki-macro CODE" lang="bash"></span> asetup
19.2.5.30,here \# or whichever athena version you prefer cmt co -r
PowhegControl-00-03-00 Generators/PowhegControl \# or use HEAD as the
version to get the trunk setupWorkArea.py cd WorkArea/cmt cmt br "cmt
config; make" <span class="twiki-macro ENDCODE"></span> \</sticky\>

If you need a specific version of External/Powheg (unlikely) then you
can check that out too.

## Re-using integration files

If the integration step (before events are generated) is lengthy, the
integration step can be skipped by re-using the Powheg integration
grids. Please note that there are usually three or four steps in Powheg
on the fly event generation:

  - Powheg integration
  - Powheg event generation
  - Athena-based event hadronisation (eg. with PYTHIA or HERWIG)
  - (optional) event filtering.

By re-using the Powheg integration grids only the first of these steps
can be skipped. The following files (produced during a local run) are
needed:

\<div align="center"\>

| Generation stage |               V1 jobs                |               V2 jobs                |               RES jobs               |
| :--------------: | :----------------------------------: | :----------------------------------: | :----------------------------------: |
|        1         |  `pwgxgrid.dat`, `pwggridinfo*.dat`  |  `pwg*xg*.dat`, `pwggridinfo*.dat`   |           `pwg*xgrid*.dat`           |
|        2         |    `pwg*upb*.dat`, `pwggrid*.dat`    |    `pwg*upb*.dat`, `pwggrid*.dat`    |    `pwg*upb*.dat`, `pwggrid*.dat`    |
|        3         | `pwgfullgrid*.dat`, `pwgubound*.dat` | `pwgfullgrid*.dat`, `pwgubound*.dat` | `pwgfullgrid*.dat`, `pwgubound*.dat` |

\</div\>

For local running/testing it is sufficient that they are in the local
working directory. For production both files should be put into a tar
file using the following command:

\<sticky\> <span class="twiki-macro CODE" lang="bash"></span> tar -czvf
group.phys-gener.powheg\_\<version\>.\<RunNumber\>.\<ProcessDescription\>\_\<CoM
Energy\>.TXT.\<CampaignName\>\_v1.\_00001.tar.gz \<FileList\>
<span class="twiki-macro ENDCODE"></span> \</sticky\>

where `version` is the External/Powheg version, `RunNumber` is the
intended run number and `ProcessDescription` a short process
description, similar to the physics short description of the JO name.
Please update the centre of mass energy and the campaign name (eg.
`mc15`) accordingly. This tar ball needs to be uploaded to the grid.

An automated generator for these integration grids, which takes Powheg
OTF jobOptions as input and provides an integration grid tarball as
output is here:
<https://svnweb.cern.ch/cern/wsvn/atlas-jrobinso/PowhegIntegrationGridGenerator/tags/>.
Please use the latest tag (currently
`PowhegIntegrationGridGenerator-00-01-04/`). There are instructions on
usage in the README provided with the code.

The integration grid tar ball needs to be passed to `Generate_tf.py` via
the `inputGenConfFile` argument. Contact your group production contact
for details and help. Most details given at
AtlasProtected.PreparingLesHouchesEven also apply for integration grids,
although only one file is needed here.

Please check that the use of integration grids give a significant speed
up. Sometimes most time is spend in the athena based hadronisation
process, especially if low efficiency filters are used. For example,
plain ttbar or single gauge boson processes do not need pre-made
integration grids.

Please note that integration grids generated in either single-core or
multi-core mode can be re-used. However,
<span class="twiki-macro RED"></span> **if integration files are
provided as input to a multi-core generation job, they will not be
used** <span class="twiki-macro ENDCOLOR"></span> - only single core
Powheg makes the appropriate check for existing integration grids.

## Running in multicore mode

It is possible to run POWHEG-BOX in multicore mode which can speed up
event generation by parallelising the event generation. In order to
enable this, simple set the following environment variable

`ATHENA_PROC_NUMBER`

to the desired number of cores to use.
<span class="twiki-macro RED"></span> **Running event generation in
multicore mode ignores any integration files that are provided by the
user.** <span class="twiki-macro ENDCOLOR"></span>

## Running with multiple scale/PDF weights (V2 processes only)

In POWHEG version 2, support was enabled for multiple weights to be
stored per event, representing multiple scale variations or PDFs. To
enable this behaviour, simply provide a python list to the `PDF` and/or
the `mu_R` and `mu_F` properties of `PowhegConfig`. For example

\<sticky\> <span class="twiki-macro CODE" lang="python"></span>
include('PowhegControl/PowhegControl\_WZ\_Common.py') PowhegConfig.PDF =
range(10800, 10853) PowhegConfig.mu\_F = \[1.0, 0.5, 0.5, 0.5, 2.0, 2.0,
2.0\] PowhegConfig.mu\_R = \[1.0, 0.5, 1.0, 2.0, 0.5, 1.0, 2.0\]
PowhegConfig.generate() ... <span class="twiki-macro ENDCODE"></span>
\</sticky\>

The desired nominal values **MUST** be first in each list. If using
`mu_F` and `mu_R`, the two lists **MUST** be the same length.

## Running with multiple non-scale/PDF weights (V2 processes only)

Newer Powheg processes are able to re-run with other parameters changed,
giving additional weights as output in the same way as for scale/PDF
variations. The first thing to do is to define one or more groups of
event weights, each one needs a name and a list of the parameters that
will be altered, which can include scale/PDF parameters if desired.

In the example below, a weight group called `quark_mass_variation` is
defined, which consists of a series of variations of the
`bmass_in_minlo` and `quarkmasseffects` parameters

\<sticky\> <span class="twiki-macro CODE" lang="python"></span>
PowhegConfig.define\_event\_weight\_group(group\_name='quark\_mass\_variation',
parameters\_to\_vary=\['bmass\_in\_minlo', 'quarkmasseffects'\])
<span class="twiki-macro ENDCODE"></span>

Next, one output weight must be defined for each set of parameter
variations. The name of the group to which this belongs **MUST** be
provided, along with the name of the weight and a value for each of the
parameters specified in the group definition. In the example below,
three weights are defined, one enables `quarkmasseffects` only, one
which disables both `bmass_in_minlo` and `quarkmasseffects` and one
which enables both. Other combinations are of course possible.

\<sticky\> <span class="twiki-macro CODE" lang="python"></span>
PowhegConfig.add\_weight\_to\_group(group\_name='quark\_mass\_variation',
weight\_name='mtmb', parameter\_values=\[0, 1\])
PowhegConfig.add\_weight\_to\_group(group\_name='quark\_mass\_variation',
weight\_name='mtinf', parameter\_values=\[0, 0\])
PowhegConfig.add\_weight\_to\_group(group\_name='quark\_mass\_variation',
weight\_name='mtmb-bminlo', parameter\_values=\[1, 1\])
<span class="twiki-macro ENDCODE"></span>

The number of parameter values provided **MUST** be equal to the number
specified in the group definition or generation will terminate\! The
example above will produce the following weights:

\<div align="center"\>

| Weight name | PowhegControl options                      |
| :---------- | :----------------------------------------- |
| mtmb        | bmass\_in\_minlo = 0, quarkmasseffects = 1 |
| mtinf       | bmass\_in\_minlo = 0 quarkmasseffects = 0  |
| mtmb-bminlo | bmass\_in\_minlo = 1 quarkmasseffects = 1  |

\</div\>

Please bear in mind that you cannot use the reweighting mechanism with
parameters related to the real cross-section, such as `hdamp`.
Reweighting is only applied to the inclusive cross section (what Powheg
calls the Bbar function), while the hardest radiation, built on top of
it, is left as is. Since the `hdamp` parameter selects the part of the
real cross section to be used for generating radiation, it cannot be
reweighted.

## Running NNLO reweighting (V2 processes only)

Some processes (currently only `Hj`, `Wj` and `Zj`) come with external
reweighting programs which can take the LHE events and provide
event-by-event weights which approximate the full NNLO distribution. The
syntax is slightly different for NNLOPS for `Hj` and DYNNLO for `Wj` and
`Zj`

**NNLOPS for Hj** needs two input commands. The first,
`NNLO_reweighting_inputs` needs arguments which map `name` to
`file_name` where `file_name` is pre-generated reweighting file and
`name` is a user-specified name for the weight corresponding to this.
Similarly `NNLO_output_weights` takes arguments which map `name` to
`operation` where `operation` is a command in the NNLOPS mini-language
and `name` is a user-specified name for the output weight resulting from
this operation.

\<sticky\> <span class="twiki-macro CODE" lang="python"></span>
\#-------------------------------------------------------------- \#
EVGEN configuration
\#--------------------------------------------------------------
evgenConfig.description = 'POWHEG H+jet production with NNLOPS'
evgenConfig.keywords = \[ 'Higgs', '1jet' \] evgenConfig.contact = \[
'<james.robinson@cern.ch>' \]

\#-------------------------------------------------------------- \#
Powheg Hj setup starting from ATLAS defaults
\#--------------------------------------------------------------
include('PowhegControl/PowhegControl\_Hj\_Common.py')
PowhegConfig.NNLO\_reweighting\_inputs\["nn-mtinf"\] =
"H1250\_CM13\_CT10\_APX0\_11.top"
PowhegConfig.NNLO\_reweighting\_inputs\["nn-mtmb"\] =
"H1250\_CM13\_CT10\_APX2\_22.top"
PowhegConfig.NNLO\_output\_weights\["nnlops-mtmb"\] = "combine 'nn-mtmb'
and 'mtmb'" PowhegConfig.NNLO\_output\_weights\["nnlops-mtinf" =
"combine 'nn-mtinf' and 'mtinf'"
PowhegConfig.NNLO\_output\_weights\["'nnlops-mtmb-bminlo"\] = "combine
'nn-mtmb' and 'mtmb-bminlo'" PowhegConfig.generate()
<span class="twiki-macro ENDCODE"></span> \</sticky\>

**DYNNLO for Wj and Zj** has simpler syntax: `NNLO_output_weights` is
not needed because DYNNLO always reweights the nominal weight.

\<sticky\> <span class="twiki-macro CODE" lang="python"></span>
\#-------------------------------------------------------------- \#
EVGEN configuration
\#--------------------------------------------------------------
evgenConfig.description = 'POWHEG W+jet production with DYNNLO'
evgenConfig.keywords = \[ 'SM', 'W', '1jet' \] evgenConfig.contact = \[
'<james.robinson@cern.ch>' \]

\#-------------------------------------------------------------- \#
Powheg Wj setup starting from ATLAS defaults
\#--------------------------------------------------------------
include('PowhegControl/PowhegControl\_Wj\_Common.py')
PowhegConfig.NNLO\_reweighting\_inputs\["DYNNLO"\] =
"Wp\_CM8\_MMHT14NNLO\_11.top'" PowhegConfig.generate()
<span class="twiki-macro ENDCODE"></span> \</sticky\>

**Available reweighting files** have already been generated for the `Hj`
and `Wj` processes. where the naming convention is `${process
description}_CM${energy}_${PDF}_${further
details}_${renormalisation/factorisation scales}`. We **will not** make
these files ourselves, but if you provide them, we are happy to include
them in future releases. You can see a full list of available
reweighting files available in the release that you're using by running
the command:

\<sticky\> <span class="twiki-macro CODE" lang="bash"></span> ls
${POWHEGPATH}/AuxFiles/\*/ <span class="twiki-macro ENDCODE"></span>
\</sticky\>

<span class="twiki-macro TWISTY twikiHelp" data-mode="div" data-showlink="Expand Hj NNLO reweighting files" data-hidelink="Hj NNLO reweighting files" data-showimgright="%ICONURLPATH{toggleopen-small}%" data-hideimgright="%ICONURLPATH{toggleclose-small}%"></span>

  - H1250\_CM13\_CT10\_APX0\_11.top
  - H1250\_CM13\_CT10\_APX2\_11.top
  - H1250\_CM13\_CT10\_APX2\_22.top
  - H1250\_CM13\_CT10\_APX2\_HH.top
  - H1250-CM13-NNPDF3-APX0-HH.top
  - H1250-CM13-NNPDF3-APX1-HH.top
  - H1250-CM13-NNPDF3-APX2-11.top
  - H1250-CM13-NNPDF3-APX2-HH.top
  - H1250-CM13-NNPDF3-APX2-QQ.top
  - H1250\_CM13\_PDF4LHC30-APX0-11.top
  - H1250-CM13-PDF4LHC30-APX0-HH.top
  - H1250-CM13-PDF4LHC30-APX1-HH.top
  - H1250\_CM13\_PDF4LHC30-APX2-11.top
  - H1250\_CM13\_PDF4LHC30-APX2-22.top
  - H1250\_CM13\_PDF4LHC30-APX2-HH.top
  - H1250\_CM13\_PDF4LHC30-APX2-QQ.top
  - H1250\_CM8\_CT10\_APX0\_11.top
  - H1250\_CM8\_CT10\_APX2\_11.top
  - H1250\_CM8\_CT10\_APX2\_22.top
  - H1250\_CM8\_CT10\_APX2\_HH.top

<span class="twiki-macro ENDTWISTY"></span>
<span class="twiki-macro TWISTY twikiHelp" data-mode="div" data-showlink="Expand Wj NNLO reweighting files" data-hidelink="Wj NNLO reweighting files" data-showimgright="%ICONURLPATH{toggleopen-small}%" data-hideimgright="%ICONURLPATH{toggleclose-small}%"></span>

  - Wp\_CM8\_MMHT14NNLO\_11.top

<span class="twiki-macro ENDTWISTY"></span>

Please bear in mind that it is not possible for PowhegControl to check
the syntax of the commands provided to the reweighters:
<span class="twiki-macro RED"></span> this is the responsibility of the
user <span class="twiki-macro ENDCOLOR"></span>. Common errors are:

  - specifying reweighting input files that are not in our repository
    and have not been provided by the user
  - trying to combine weights that have not been specified.

Either of these will cause the reweighter to crash in hard-to-debug
ways.

## Running with post-processing from MadSpin

For some processes involving tops, it may be interesting to run MadSpin
over the (undecayed) tops from Powheg to correctly model their spins.
PowhegControl provides a convenient interface for doing this, which must
be enabled by setting the tops as undecayed (for example
=PowhegConfig.decay\_mode = "t t\~ \> undecayed"= in the case of the
`tt` process). The following options can then be set in the usual way

\<div align="center"\>

|                 Option                  |               Default | Meaning                                                              |
| :-------------------------------------: | --------------------: | :------------------------------------------------------------------- |
|      `PowhegConfig.MadSpin_decays`      | leptonic and hadronic | decays allowed by MadSpin                                            |
|     `PowhegConfig.MadSpin_enabled`      |                  True | set this to `False` if you want undecayed tops without using MadSpin |
|      `PowhegConfig.MadSpin_model`       |          loop\_sm-ckm | which model to import in MadSpin                                     |
|       `PowhegConfig.MadSpin_mode`       |                  full | which spin mode to use in MadSpin                                    |
|    `PowhegConfig.MadSpin_nFlavours`     |                     4 | which flavour scheme to use                                          |
|     `PowhegConfig.MadSpin_process`      |     process-dependent | process that MadSpin is operating on                                 |
| `PowhegConfig.MadSpin_taus_are_leptons` |                  True | whether lepton definitions should include taus                       |

\</div\>

**You** are responsible for ensuring that the options passed to MadSpin
are correct. A common error is requesting `MadSpin_decays` or
`MadSpin_process` that are not possible with the input Powheg LHE events
(for example, asking MadSpin to decay both tops and antitops in a sample
which contains only tops).

-----

# UNSUPPORTED

<span class="twiki-macro TWISTY twikiHelp" data-mode="div" data-showlink="Testing unsupported versions of processes with Powheg OTF" data-hidelink="Testing unsupported versions of processes with Powheg OTF." data-showimgright="%ICONURLPATH{toggleopen-small}%" data-hideimgright="%ICONURLPATH{toggleclose-small}%"></span>
If you want to test a process through Powheg OTF, it is sometimes
possible to have it installed on afs, after which one can manually point
Powheg OTF to this location. Firstly, check out the `External/Powheg`
and `Generators/PowhegControl` packages as described earlier.

Then one has to change the `POWHEGPATH` environment variable to point to
the location of the unofficial installation:

\<sticky\> <span class="twiki-macro CODE" lang="bash"></span> export
POWHEGPATH=/afs/direct\_path\_to\_installed\_process
<span class="twiki-macro ENDCODE"></span> \</sticky\>

One can then run the job as usual, and the version pointed to by
`POWHEGPATH` will be used. <span class="twiki-macro ENDTWISTY"></span>

<span class="twiki-macro TWISTY twikiHelp" data-mode="div" data-showlink="Testing private Powheg run cards with Powheg OTF" data-hidelink="Testing private Powheg run cards with Powheg OTF" data-showimgright="%ICONURLPATH{toggleopen-small}%" data-hideimgright="%ICONURLPATH{toggleclose-small}%"></span>
For debugging, it may occasionally be useful to use the Powheg OTF
machinery to generate events according to a privately provided run card.
If you do this

  - we won't provide support
  - you won't be able to request central production of your events

However, for private testing, this can be enabled by replacing the call
to

\<sticky\> <span class="twiki-macro CODE" lang="python"></span>
PowhegConfig.generate() <span class="twiki-macro ENDCODE"></span>
\</sticky\> with \<sticky\>
<span class="twiki-macro CODE" lang="python"></span>
PowhegConfig.generate(use\_external\_run\_card=True)
<span class="twiki-macro ENDCODE"></span> \</sticky\>

The job can then be run as usual, with all settings from Powheg OTF
ignored in favour of settings from the private run card.

Note that using external run cards does not seem to work when generating
events in *multicore* mode due to PowhegControl interfering. Please
contact the Powheg OTF maintainers if you need this, we may be able to
provide it. <span class="twiki-macro ENDTWISTY"></span>

<span class="twiki-macro TWISTY twikiHelp" data-mode="div" data-showlink="Generating Powheg run cards with Powheg OTF" data-hidelink="Generating Powheg run cards with Powheg OTF" data-showimgright="%ICONURLPATH{toggleopen-small}%" data-hideimgright="%ICONURLPATH{toggleclose-small}%"></span>
For debugging, it may occasionally be useful to use the Powheg OTF
machinery to produce run cards which can be tested by non-ATLAS experts
(eg. the process authors). This can be enabled by replacing the call:

\<sticky\> <span class="twiki-macro CODE" lang="python"></span>
PowhegConfig.generate() <span class="twiki-macro ENDCODE"></span>
\</sticky\> with \<sticky\>
<span class="twiki-macro CODE" lang="python"></span>
PowhegConfig.generate(create\_run\_card\_only=True)
<span class="twiki-macro ENDCODE"></span> \</sticky\>

The job should be run as usual, but will terminate after the run card
has been produced. <span class="twiki-macro ENDTWISTY"></span>

# Contact Persons

For specific Powheg OTF request you can send an e-mail to Dan Hayden and
Stefan Richter on <atlas-generators-powhegcontrol@cern.ch>. Developers:
ongoing work and current status:
[Link](https://docs.google.com/spreadsheets/d/10hMg4QcfEs7UgBXklrCEcVMHZOWxCXtI5drEnQ5HcdU/edit?usp=sharing).

[See here for contact persons for selected processes. Otherwise send a
mail to
hn-atlas-generators.](https://twiki.cern.ch/twiki/bin/viewauth/AtlasProtected/McGeneratorsForAtlas#Next_to_leading_Order_NLO_Genera)

-----

**Major updates**:
\-- Main.RiccardoDiSipio - 05-Oct-2009 -- Main.ChristophWasicki -
11-Sept-2012 -- Main.JamesRobinson - 22-May-2013

<span class="twiki-macro RESPONSIBLE"></span>
<span class="twiki-macro REVINFO" rev="1.1">Main.JamesRobinson</span>
<span class="twiki-macro REVIEW"></span> **Never reviewed**

<span class="twiki-macro STOPINCLUDE"></span>
