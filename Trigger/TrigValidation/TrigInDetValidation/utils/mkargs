#!/bin/csh

set dir = .


if ( $#argv > 0 ) then 
   set dir = $1
endif

set files = ""



foreach arg ( $argv )
  set   dir = $1
  set   base = `basename $dir .xml`
  set   basetail = ${dir:t}

  if ( "$base" != "$basetail" ) then 
     set files = "$files $1"
  else
     set files = "$files $dir/*.xml"
  endif
 
#  echo "files: $files" 

  shift
end

echo "files: $files"


foreach xmlfile ( $files ) 

   set _file = `basename $xmlfile .xml`
      
#  echo "xmlfile $xmlfile  $_file"

 
#   if ( "$_file" != "TrigInDetValidation_TestConfiguration_main.xml" ) then 
    if ( -e $_file.sh ) then 
      echo "file $_file.sh already exists"
      continue
    endif

      set gpath = ${xmlfile:h}

      cpp -traditional-cpp -I$gpath $xmlfile  -DSTAR="*" | grep -v "\# " | grep -v "emacs:" > /tmp/$_file.xml

     set duff = `grep dataset /tmp/$_file.xml`


     if ( "$duff" != "" ) then 

      set file = `echo $_file | sed 's/\.xml//g'`

      echo "#\!/bin/sh" > $_file.sh
      chmod u+x $_file.sh

      grep "<argvalue>" /tmp/$_file.xml |  sed 's|<argvalue>||g' | sed 's|</argvalue>||g' > /tmp/_args


#     grep "<commandLineFlags>" $xmlfile |  sed 's|<commandLineFlags>||g' | sed 's|</commandLineFlags>||g'
#     grep "<options>" $xmlfile |  sed 's|<options>||g' | sed 's|</options>||g'


      set cmdlineflags = `grep "<commandLineFlags>" /tmp/$_file.xml |  sed 's|<commandLineFlags>||g' | sed 's|</commandLineFlags>||g' | sed "s/'/"\""/g"`

      set joboptions   = `grep "<options>" /tmp/$_file.xml |  sed 's|<options>||g' | sed 's|</options>||g'`



#       ${0:h}/mkdatasets /tmp/$_file.xml

# #     echo "files $file - looking for basename"

        set jobid = `basename $xmlfile .xml`

#       set pyfile = {$jobid}.py

# #     echo "pyfile $pyfile"
      
# #     echo "joboption $joboptions    cmdlineflags $cmdlineflags"

      if ( "$joboptions" != "" ) then 
         echo "\nget_files -jo $joboptions.py" >> $_file.sh
#        echo  "athena.py  -c 'include("\"$pyfile\"";$cmdlineflags' $joboptions.py \n\n" >> $_file.sh
         echo  "athena.py  -c 'XMLDataSet="\"$jobid\"";$cmdlineflags' $joboptions.py \n\n" >> $_file.sh
      endif
  
#     cat /tmp/_args

      set N = `cat /tmp/_args | wc -l`

      echo "file: $_file.sh" 

      if ( $N > 0 ) then 

        set command = ""

        while ( $N > 0 )
  
           set arg = `tail -$N /tmp/_args | head -1`

   	   if ( "$arg" == "TIDArdict.exe" || "$arg" == "TIDAcomparitor.exe" || "$arg" == "TIDAcpucost.exe" || "$arg" == "RunTrigCostD3PD.exe" ) then 
              if ( "$command" != "" ) then 
                 echo "$command\n" >> $_file.sh
              endif
              set command = "$arg"
            else 

	      if ( "$command" == "TIDAcpucost.exe" ) then 
                 set auxfile = `grep auxFile /tmp/$_file.xml | grep expert | sed 's|.*<auxFilePattern>||g' | sed 's|</auxFilePattern>||g'`
                 set arg = `echo "$arg" | sed "s| \S*\*\S* | $auxfile |g"`
              endif

	      foreach ffile ( $arg )
                 set ext = `echo $ffile | cut -d . -f2` 
                 set ref = `echo $ffile | grep ".*ref.*.root"`
#                echo "ffile: $ffile" 
#		 echo "ref: $ref     : ext: $ext"
                 if ( "$ext" == "dat" || "$ref" != "" )  then 
#                   echo "   getting file $ffile"   
		    echo "get_files -data $ffile" >> $_file.sh 
                 endif
              end
              set command = "$command $arg"
           endif

           @ N--
 
        end

        if ( "$command" != "" ) then 
          echo  "$command\n\n"  >> $_file.sh
        endif

      endif

    endif
   endif

end



# <dataset>/eos/atlas/atlascerngroupdisk/proj-sit/vchavda/TrigInDetValidation_muon/mc10_14TeV.106047.PythiaZmumu_no_filter.digit.RDO.e662_s1107_d459_tid285222_00/RDO.285222._000174.pool.root.1</dataset>
