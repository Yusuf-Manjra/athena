# **********************************************************************
# $Id: $
# **********************************************************************

#######################
# HLT Offline Shifter 
#######################

#######################
# Output
#######################

output top_level {

  output HLT {
    output OfflineShifter {
      output Et-Pt-Spectra {
        output BPhys {
        }
        output Jets {
        }
        output Tau {
        }
        output Egamma {
        }
      }
      output Eta-Phi-Maps {
        output Calo {
        }
        output Jets {
        }
        output Muons {
        }
        output Tau {
        }
        output Egamma {
        }
      }
      output InvariantMasses {
      }
      output Misc {
        output Bjet {
        }
        output InDet {
        }
        output Muons {
        }
        output MissingET {
        }
        output Tau {
        }
        output Egamma {
        }
        output MinBias {
	  output MBTS {
	  }
	  output BCM {
	  }
	  output IDMinbias {
	  }
	  output LUCID {
	  }
##	  output ZDC {
##	  }
        }
      }
      output Multiplicities {
        output Tau {
        }
      }
    }
  }
}


#######################
# Histogram Assessments
#######################

dir HLT {

  #algorithm = HLT_Histogram_Not_Empty&GatherData
  #algorithm = BPhys_HistKolmogorovTest_MaxDist

  dir CaloMon {
    hist EnergyAccetaphiTile@Shifter {
##        algorithm = HLT_Histogram_Not_Empty&GatherData 
        algorithm = HLT_PassInput
        output = HLT/OfflineShifter/Eta-Phi-Maps/Calo
    }
    hist EnergyAccetaphiLAr@Shifter {
##        algorithm = HLT_Histogram_Not_Empty&GatherData 
        algorithm = HLT_PassInput
        output = HLT/OfflineShifter/Eta-Phi-Maps/Calo
    }
  }

  dir ResultMon {
    dir AllChains {
      hist AllChainsRoIs@Shifter {
##        regex = 1
##        algorithm = HLT_Histogram_Not_Empty&GatherData
        algorithm = HLT_PassInput
        output = HLT/OfflineShifter/Eta-Phi-Maps
      }
    }
    
    dir Electrons {
      hist [^L].*RoI.*@Shifter {
        regex = 1
        algorithm = HLT_Histogram_Not_Empty&GatherData
        output = HLT/OfflineShifter/Eta-Phi-Maps
      }
    }
    
    dir Gamma {
      hist [^L].*RoI.*@Shifter {
        regex = 1
        algorithm = HLT_Histogram_Not_Empty&GatherData
        output = HLT/OfflineShifter/Eta-Phi-Maps
      }
    }
    
    dir Muons {
      hist [^L].*RoI.*@Shifter {
        regex = 1
        algorithm = HLT_Histogram_Not_Empty&GatherData
        output = HLT/OfflineShifter/Eta-Phi-Maps
      }
    }
    
    dir Taus {
      hist [^L].*RoI.*@Shifter {
        regex = 1
        algorithm = HLT_Histogram_Not_Empty&GatherData
        output = HLT/OfflineShifter/Eta-Phi-Maps
      }
    }
       
  }

  dir METMon {
    algorithm = HLTmet_Histogram_Not_Empty&GatherData
    output = HLT/OfflineShifter/Misc/MissingET
    dir HLT {
      hist HLT_MET_status@Shifter {
        display = TCanvas(1050,500),LogY
        algorithm = HLTmet_AlgErrorBits
        output = HLT/OfflineShifter/Misc/MissingET
        description = Normal: GlobalError bin is empty (not filled). Abnormal But Not Critical: 1. Bytestream conversion errors in some components (TileBar, Gap1,2,3, Ext1,2). 2. BadCellQuality in one or more components. Abnormal and Critical: Global Error bit is set "GlobError" or Missing Components - Cross check with compN_EF_MET_status@Shifter
      }
      hist HLT_MET_lin@Shifter {
        display = <AxisRange(0,100,"X")>,LogY
        output = HLT/OfflineShifter/Misc/MissingET
        description = Normal: No spikes, with a single dip structure and a falling distribution. Abnormal: Spike in EF_MET at low (< 10 GeV) MET shifter should contact expert-on-call.
      }
      hist HLT_MET_log@Shifter {
        display = LogY
        output = HLT/OfflineShifter/Misc/MissingET
        description = Normal: No spikes, with a single dip structure and a falling distribution. Abnormal: Spike in EF_MET at low (< 10 GeV) MET shifter should contact expert-on-call.
      }
      hist HLT_MET_phi@Shifter {
        display = LogY
        output = HLT/OfflineShifter/Misc/MissingET
        description = Azimuthal distribution of MET. Normal: Smooth cosine distribution without spikes is normal. Abnormal: Spikes indicate problems. Cross check with EF_MET_phi1@Shifter.
      }
      hist HLT_MET_phi1@Shifter {
        display = LogY
        output = HLT/OfflineShifter/Misc/MissingET
        description = Azimuthal distribution of MET weighted by MET in each phi-bin. Normal: Smooth cosine distribution without spikes is normal. Abnormal: Spikes indicate problems in the specific phi-region where spikes occur. Cross check with MET components to see if there is a large MET contribution from one or more components (for example Tile1). Isolate the offending component and check with the calorimeter experts for noisy channels in the respective component.
      }
      hist HLT_SumEt_lin@Shifter {
        display = <AxisRange(0,500,"X")>,LogY
        output = HLT/OfflineShifter/Misc/MissingET
        description = Normal: SumET > 0 with a single dip structure is normal. Abnormal: SumET = 0 is critically abnormal
      }
      hist HLT_SumEt_log@Shifter {
        display = LogY
        output = HLT/OfflineShifter/Misc/MissingET
        description = Normal: SumET > 0 with a single dip structure is normal. Abnormal: SumET = 0 is critically abnormal
      }
      hist HLT_SumE_log@Shifter {
        display = LogY
        output = HLT/OfflineShifter/Misc/MissingET
      }
      hist compN_compEt@Shifter {
        display = TCanvas(1050,500)
        output = HLT/OfflineShifter/Misc/MissingET
        description = Normal: All components (X bins) are filled. Abnormal: One or more components are empty.
      }
      hist compN_compSumEt@Shifter {
        display = TCanvas(1050,500)
        output = HLT/OfflineShifter/Misc/MissingET
        description = Normal: All components (X bins) are filled and >= 0. Abnormal: One or more components are empty
      }
      hist compN_compSumEt_lin@Shifter {
        display = TCanvas(1050,500)
        algorithm = HLTmet_AlgComponents
        output = HLT/OfflineShifter/Misc/MissingET
        description = Normal: All components (X bins) are filled and >= 0. Abnormal: One or more components are empty
      }
      hist compN_compSumE@Shifter {
        display = TCanvas(1050,500)
        output = HLT/OfflineShifter/Misc/MissingET
        description = Normal: All components (X bins) are filled and >= 0. Abnormal: One or more components are empty
      }
      hist compN_HLT_MET_status@Shifter {
        display = TCanvas(1050,500),LogZ
        output = HLT/OfflineShifter/Misc/MissingET
        description = Normal: "Processed" Bit must always be set (and filled). Abnormal But Not Critical: 1. Bytestream conversion errors in some components (TileBar, Gap1,2,3, Ext1,2); 2. BadCellQuality in one or more components. Abnormal and Critical: Global Error bit is set "GlobError" or Missing components or Error in one or more components "CompError".
      }
      hist compN_HLT_usedChannels@Shifter {
        display = TCanvas(1050,500),LogZ
        output = HLT/OfflineShifter/Misc/MissingET
        description = This histogram indicates the number of channels used in calculating MET from various calorimeter components. Each bin on X-axis corresponds to a component. The Y-axis shows the number of used channels. Normal: The first Y-bin (indicated by "none") must always be empty for normal operation. Abnormal: In case the channels from one or more components is not used, the none column will be filled and indicates a problem with that component.
      }

    }
  }


  dir MuonMon {
    dir muComb {
      hist muComb_ptratio_toMF@OfflineShifter {
        output = HLT/OfflineShifter/Misc/Muons
        algorithm = alg_muComb_ptratio
	description = Should have a peak around 1. Please compare with reference histogram.
        weight = 0.0
      }
      hist muComb_dR_toMF@OfflineShifter {
        output = HLT/OfflineShifter/Misc/Muons
        description = Should have a peak at small value (< 0.05). If there are many (> several %) at overflow it may indicate something. Please compare with reference histogram. 
        algorithm = TRMUO_GatherData
      }
    }
  }


  dir JetMon {
      dir HLT {
      }
  }


  dir TauMon {
    dir tauNoCut_L1TAU40 {
      dir L1RoI {
        hist hL1RoITauClus@Shifter2 {
          output = HLT/OfflineShifter/Et-Pt-Spectra/Tau
          algorithm = HLT_TAU_Histogram_Not_Empty&GatherData
          reference = CentrallyManagedReferences
          display = StatBox
          description = This variable should have smoothly falling (exponential) distribution. Problems in the calorimeter or L1 hardware can cause a bumpy structure in the distribution.
        }
      }
      dir T2CaloTau {
        hist hEtRawNarrow@Shifter2 {
          algorithm = HLT_TAU_Histogram_Not_Empty&GatherData
          reference = CentrallyManagedReferences
          display = StatBox
          output = HLT/OfflineShifter/Et-Pt-Spectra/Tau
        }
      }
    } #end tauNoCut_L1TAU40
    dir tauNoCut {
      dir L1RoI {
        hist hL1RoITauClus@Shifter {
          output = HLT/OfflineShifter/Et-Pt-Spectra/Tau
          algorithm = HLT_TAU_Histogram_Not_Empty&GatherData
          reference = CentrallyManagedReferences
          description = This variable should have smoothly falling (exponential) distribution. Problems in the calorimeter or L1 hardware can cause a bumpy structure in the distribution.
          display = StatBox
        }
        hist hL1EtaVsPhi@Shifter {
          output = HLT/OfflineShifter/Eta-Phi-Maps/Tau
          algorithm = HLT_TAU_Histogram_Not_Empty&GatherData
          reference = CentrallyManagedReferences
          description = https://twiki.cern.ch/twiki/bin/view/Atlas/TauSliceDataQualityMonitoring#hEtaVsPhi
          display = StatBox
        }
        hist hL1RoIEta@Shifter {
            output = HLT/OfflineShifter/Eta-Phi-Maps/Tau
            algorithm = HLT_TAU_Histogram_Not_Empty&GatherData
            reference = CentrallyManagedReferences
            description = This distribution should be approximately flat. An excess of events at a particular eta (a peak) can be due to the presence of hot tower. There may also be data integrity problems with LArg or Tile calorimeter. Please look at the calorimeter data quality variables and E-log entries to verify the exact conditions used for the particular run. If neither of the above is true, please contact the tau trigger expert on-call.
            display = StatBox
        }
        hist hL1RoIPhi@Shifter {
            output = HLT/OfflineShifter/Eta-Phi-Maps/Tau
            algorithm = HLT_TAU_Histogram_Not_Empty&GatherData
            reference = CentrallyManagedReferences
            description = This distribution should be approximately flat. An excess of events at a particular phi (a peak) can be due to the presence of hot tower. There may also be data integrity problems with LArg or Tile calorimeter. Please look at the calorimeter data quality variables and E-log entries to verify the exact conditions used for the particular run. If neither of the above is true, please contact the tau trigger expert on-call.
            display = StatBox
        }
      }
      dir T2CaloTau {
        hist hEtRawNarrow@Shifter {
          algorithm = HLT_TAU_Histogram_Not_Empty&GatherData
          reference = CentrallyManagedReferences
          display = StatBox
          description = Smoothly falling exponential distribution. If you see a bumpy structure, check for any hot cells reported by L1Calo.
          output = HLT/OfflineShifter/Et-Pt-Spectra/Tau
        }
        hist hEMRadius3S@Shifter {
          algorithm = HLT_TAU_Histogram_Not_Empty&GatherData
          reference = CentrallyManagedReferences
          display = StatBox
          description = Distribution should have a peak close to zero and should smoothly fall at high values.
          output = HLT/OfflineShifter/Misc/Tau
        }
        hist hEta@ShifterL2 {
          output = HLT/OfflineShifter/Eta-Phi-Maps/Tau
          algorithm = HLT_TAU_Histogram_Not_Empty&GatherData
          reference = CentrallyManagedReferences
          display = StatBox
        }
        hist hPhi@ShifterL2 {
            output = HLT/OfflineShifter/Eta-Phi-Maps/Tau
            algorithm = HLT_TAU_Histogram_Not_Empty&GatherData
            reference = CentrallyManagedReferences
            display = StatBox
        }
        hist hEtaVsPhi@ShifterL2 {
          algorithm = HLT_TAU_Histogram_Not_Empty&GatherData
          reference = CentrallyManagedReferences
          description = Distribution should be uniform. https://twiki.cern.ch/twiki/bin/view/Atlas/TauSliceDataQualityMonitoring#h_EtaVsPhi
          display = StatBox
          output = HLT/OfflineShifter/Eta-Phi-Maps/Tau
        }
        hist hEMRadius3S@Shifter {
          output = HLT/OfflineShifter/Misc/Tau
          algorithm = HLT_TAU_Histogram_Not_Empty&GatherData
          reference = CentrallyManagedReferences
          description = A measure of the shower size in eta-phi obtained from an energy weighted DR of the cells associated with the tau trigger candidate around the EF position. https://twiki.cern.ch/twiki/bin/view/Atlas/TauSliceDataQualityMonitoring#hEMRadius
          display = StatBox
        }
      }
      dir T2IDTau {
        hist hNIsoTracks@Shifter {
          algorithm = HLT_TAU_Histogram_Not_Empty&GatherData
          reference = CentrallyManagedReferences
          display = StatBox
          output = HLT/OfflineShifter/Multiplicities/Tau
        }
        hist hSumPtRatio@Shifter {
          algorithm = HLT_TAU_Histogram_Not_Empty&GatherData
          reference = CentrallyManagedReferences
          display = StatBox
          output = HLT/OfflineShifter/Misc/Tau
        }
        hist hNCoreTracks@Shifter {
          output = HLT/OfflineShifter/Multiplicities/Tau
          algorithm = HLT_TAU_Histogram_Not_Empty&GatherData
          reference = CentrallyManagedReferences
          description = https://twiki.cern.ch/twiki/bin/view/Atlas/TauSliceDataQualityMonitoring#h_NCoreTracks
          display = StatBox
        }
      }
    }
  }

    
  dir MinBiasMon {
##    dir MBTS {
##    }
        
    dir IDMinbias {
      hist IDMinBiasTriggerErrors@OfflineShifter {
        output = HLT/OfflineShifter/Misc/MinBias/IDMinbias
        reference = HLTminbias_Ref
        algorithm = HLT_Histogram_Not_Empty&GatherData
        description = Trigger error bits HLT. May be red for low stat runs or because the requested Minbias triggers are not included in the run (e.g. these triggers are not in use for normal physics runs with high pile-up/mu in order to avoid slowing down the run processing).
      }
    }
  }
       
##    dir LUCID {
##    }
    
######### # no ZDC ######### 
#     dir ZDC { 
#       hist ZDC_P@OfflineShifter { 
#       output = HLT/OfflineShifter/Misc/MinBias/ZDC 
#       reference = HLTminbias_Ref 
#       algorithm = HLTminbias_Histogram_Not_Empty&GatherData 
#       description = This plot shows ZDC counts at L1 along with the requirement event to be triggered by MBTS (orthogonal triggers AND condition). May be red for low stat runs or because the requested Minbias triggers are not included in the run (e.g. these triggers are not in use for normal physics runs with high pile-up/mu in order to avoid slowing down the run processing). The reference may not match the current data, being updated accordingly while not influencing the test. 
#     } 
#       hist ZDC_F@OfflineShifter { 
#       output = HLT/OfflineShifter/Misc/MinBias/ZDC 
#       reference = HLTminbias_Ref 
#       algorithm = HLTminbias_Histogram_Not_Empty&GatherData 
#       description = This plot shows ZDC failures at L1 along with the requirement event to be triggered by MBTS (orthogonal triggers AND condition). May be red for low stat runs or because the requested Minbias triggers are not included in the run (e.g. these triggers are not in use for normal physics runs with high pile-up/mu in order to avoid slowing down the run processing). The reference may not match the current data, being updated accordingly while not influencing the test. 
#      } 
#    } ##########
#  }
}

##############
# Algorithms
##############

algorithm ShifterFermiFit {
  libname = libdqm_algorithms.so
  name = Simple_fermi_Fit
  thresholds = ShifterThreshold
  MinStat = 300
  #LikelihoodFit = 2.0
}

algorithm ShifterFermiFitOff {
  libname = libdqm_algorithms.so
  name = Simple_fermi_Fit
  thresholds = ShifterThresholdOff
  MinStat = 50
  #LikelihoodFit = 2.0
}

algorithm ShifterFermiFit100 {
  libname = libdqm_algorithms.so
  name = Simple_fermi_Fit
  thresholds = ShifterThreshold100
  MinStat = 300
  #LikelihoodFit = 2.0
}

algorithm ShifterFermiFit100_mu18_IDTrkNoCut_tight_pT_EF_eff {
  libname = libdqm_algorithms.so
  name = Simple_fermi_Fit
  thresholds = ShifterThreshold100
  MinStat = 1000
}

algorithm ShifterFermiFit100_tau125_IDTrkNoCut_pT_L2S_B_eff {
  libname = libdqm_algorithms.so
  name = Simple_fermi_Fit
  thresholds = ShifterThreshold100_tau125_IDTrkNoCut_pT_L2S_B_eff 
  MinStat = 300
}


# mu22 Shifter
algorithm TRMUO_fermi_fit_mu22_ESid_muFast_upstream_Fit {
  libname = libdqm_algorithms.so
  name = Simple_fermi_Fit_Graph
  thresholds = th_TRMUO_fermi_fit_mu22_ESid_muFast_upstream
  MinPoint = 50
  ImproveFit = 1.0
}


algorithm TRMUO_fermi_fit_mu22_ESid_muComb_upstream_Fit {
  libname = libdqm_algorithms.so
  name = Simple_fermi_Fit_Graph
  thresholds = th_TRMUO_fermi_fit_mu22_ESid_muComb_upstream
  MinPoint = 40
  ImproveFit = 1.0
}

algorithm TRMUO_fermi_fit_mu22_ESid_MuonEFCB_upstream_Fit {
  libname = libdqm_algorithms.so
  name = Simple_fermi_Fit_Graph
  thresholds = th_TRMUO_fermi_fit_mu22_ESid_MuonEFCB_upstream
  MinPoint = 40
  ImproveFit = 1.0
}

algorithm TRMUO_fermi_fit_mu22_ESid_MuGirlEF_upstream_Fit {
  libname = libdqm_algorithms.so
  name = Simple_fermi_Fit_Graph
  thresholds = th_TRMUO_fermi_fit_mu22_ESid_MuGirlEF_upstream
  MinPoint = 40
  ImproveFit = 1.0
}

###############
# Thresholds
###############

thresholds ShifterThreshold {
  limits Plateau {
    warning = 0.90
    error = 0.65
  }
#  limits Threshold {
#  }
#  limits Resolution {
#  }
}

thresholds ShifterThresholdOff {
  limits Plateau {
    warning = 0.50
    error = 0.25
  }
}

thresholds ShifterThreshold100 {
  limits Plateau {
    warning = 90.0
    error = 65.0
  }
}

thresholds ShifterThreshold100_tau125_IDTrkNoCut_pT_L2S_B_eff {
  limits Plateau {
    warning = 85.0
    error = 65.0
  }
}



#for Shift mu22
thresholds th_TRMUO_fermi_fit_mu22_ESid_muFast_upstream {
  limits Plateau {
    warning = 0.98
    error = 0.979
  }
  limits Threshold {
    warning = 22.0
    error   = 24.0
  }
  limits Resolution {
    warning = 3.0
    error   = 4.0
  }
}

thresholds th_TRMUO_fermi_fit_mu22_ESid_muComb_upstream {
  limits Plateau {
#    warning = 0.98
#   warning = 0.97 # 110909
    warning = 0.96
    error = 0.94
  }
  limits Threshold {
    warning = 22.0
    error   = 24.0
  }
  limits Resolution {
    warning = 3.0
    error   = 4.0
  }
}


thresholds th_TRMUO_fermi_fit_mu22_ESid_MuonEFCB_upstream {
  limits Plateau {
    warning = 0.98
    error = 0.979
  }
  limits Threshold {
    warning = 22.0
    error   = 24.0
  }
  limits Resolution {
    warning = 3.0
    error   = 4.0
  }
}

thresholds th_TRMUO_fermi_fit_mu22_ESid_MuGirlEF_upstream {
  limits Plateau {
#   warning = 0.96 # 110909 
    warning = 0.95
    error = 0.939
  }
  limits Threshold {
    warning = 22.0
    error   = 24.0
  }
  limits Resolution {
    warning = 3.0
    error   = 4.0
  }
}



